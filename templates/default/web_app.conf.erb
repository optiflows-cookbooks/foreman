<VirtualHost *:<%= @server_port %>>
  ServerName <%= @server_name %>
  <% if @server_aliases -%>
  ServerAlias <%= @server_aliases.join " " %>
  <% end -%>

  <% if node['foreman']['ssl'] -%>
  <IfModule mod_ssl.c>
    SSLEngine on
    SSLCACertificateFile <%= node['foreman']['ssl_ca_file'] %>
    SSLCertificateFile <%= node['foreman']['ssl_cert_file'] %>
    SSLCertificateKeyFile <%= node['foreman']['ssl_cert_key_file'] %>
  </IfModule>
  <% end -%>

  DocumentRoot <%= @docroot %>

  RailsBaseURI /
  RailsEnv <%= node['foreman']['environment'] %>

  <Directory <%= @docroot %>>
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  LogLevel info

  LogLevel info rewrite:trace1

  ErrorLog <%= @apache_log_dir %>/<%= @name %>-error.log
  CustomLog <%= @apache_log_dir %>/<%= @name %>-access.log combined

  RewriteEngine On
  RewriteCond %{HTTP_HOST}   !^<%= @server_name %> [NC]
  RewriteCond %{HTTP_HOST}   !^$
  RewriteRule ^/(.*)$        http://<%= @server_name %>/$1 [L,R=301]

  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule ^.*$ /system/maintenance.html [L]

  <% if node['foreman']['passenger']['path'] -%>
  PassengerAppRoot <%= node['foreman']['passenger']['path'] %>
  <% end -%>
  <% if node['foreman']['environment'] -%>
  PassengerAppEnv <%= node['foreman']['environment'] %>
  <% end -%>
  <% if node['foreman']['passenger']['ruby'] -%>
  PassengerRuby <%= node['foreman']['passenger']['ruby'] %>
  <% end -%>
  <% if @node['foreman']['passenger']['min_instances'] -%>
  PassengerMinInstances <%= @node['foreman']['passenger']['min_instances'] %>
  <% end -%>
  <% if node['foreman']['passenger']['start_timeout'] -%>
  PassengerStartTimeout <%= node['foreman']['passenger']['start_timeout'] %>
  <% end -%>
  <% if node['foreman']['passenger']['pre_start'] -%>
  PassengerPreStart <%= node['foreman']['passenger']['pre_start'] %>
  <% end -%>
</VirtualHost>
